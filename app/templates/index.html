<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ title or "RAG Document Search Engine" }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .row { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
        .stack { display:flex; flex-direction:column; gap:8px; }
        .card { border:1px solid #ddd; border-radius:8px; padding:12px; margin:10px 0; }
        .muted { color:#666; font-size: 0.9em; }
        table { width:100%; border-collapse: collapse; }
        th, td { border:1px solid #ddd; padding:8px; text-align:left; }
        th { background:#f7f7f7; }
        input[type="number"] { width: 80px; }
        .actions a, .actions button { margin-right: 6px; }
    </style>
    <script>
        // Delete document
        async function deleteDoc(docId) {
            if (!confirm("Are you sure you want to delete this document?")) return;
            await fetch(`/docs/delete/${docId}`, { method: "DELETE" });
            window.location.href = "/home";
        }

        // Search via AJAX
        async function performSearch(e) {
            e.preventDefault(); // prevent full page reload

            const form = e.target;
            const formData = new FormData(form);

            const res = await fetch("/search", {
                method: "POST",
                body: new URLSearchParams(formData)
            });

            const html = await res.text();
            document.getElementById("results").innerHTML = html;
        }
    </script>
</head>
<body>
<div class="container">

    <!-- Header -->
    <div class="row" style="justify-content: space-between;">
        <h2>Welcome, {{ email }}</h2>
        <form method="get" action="/auth/logout" style="margin:0;">
            <button type="submit">Logout</button>
        </form>
    </div>

    <!-- Global Search -->
    <div class="card">
        <h3>Search Across Your Documents</h3>
        <form id="searchForm" onsubmit="performSearch(event)">
            <input type="hidden" name="email" value="{{ email }}">
            <div class="stack">
                <input type="text" id="queryInput" name="query" placeholder="Enter your query..." required>
                <div class="row">
                    <label>Temperature
                        <input type="number" id="temperatureInput" name="temperature" min="0" max="1" step="0.1" value="{{ temperature or 0.7 }}">
                    </label>
                    <label>Top-K
                        <input type="number" id="topkInput" name="top_k" min="1" max="10" value="{{ top_k or 5 }}">
                    </label>
                    <label>Max Tokens
                        <input type="number" name="max_tokens" min="50" max="1000" value="{{ max_tokens or 300 }}">
                    </label>
                    <button type="submit">Search</button>
                </div>
                <div class="muted">
                    Defaults: low temperature (safer), Top-K controls how many chunks are retrieved, Max Tokens bounds response size.
                </div>
            </div>
        </form>
    </div>

    <!-- Search Results (dynamic) -->
    <div id="results"></div>

    <!-- Docs table -->
    <h3>Your Documents</h3>
    {% if documents and documents|length > 0 %}
        <table>
            <thead>
                <tr>
                    <th>Document Name</th>
                    <th>Uploaded Date</th>
                    <th>Size (KB)</th>
                    <th>Total Words</th>
                    <th>Total Sentences</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
            {% for doc in documents %}
                <tr>
                    <td>{{ doc.doc_name }}</td>
                    <td>{{ doc.doc_uploaded_date.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>{{ doc.size }}</td>
                    <td>{{ doc.total_words }}</td>
                    <td>{{ doc.total_sentences }}</td>
                    <td class="actions">
                        <a href="/docs/download/{{ doc.doc_id }}">Download</a> |
                        <button type="button" onclick="deleteDoc({{ doc.doc_id }})">Delete</button>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No documents uploaded yet.</p>
    {% endif %}

    <!-- Upload -->
    <div class="card">
        <h3>Upload New Document</h3>
        <form method="post" action="/upload/" enctype="multipart/form-data">
            <input type="hidden" name="email" value="{{ email }}">
            <input type="file" name="file" required>
            <button type="submit">Upload</button>
        </form>
    </div>

</div>
</body>
</html>
